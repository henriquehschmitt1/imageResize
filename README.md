
# Serverless Image Resizing Pipeline with AWS Lambda, S3, and LocalStack

This project demonstrates an event-driven serverless architecture for automatically resizing images uploaded to an S3 bucket. It uses AWS Lambda, S3, and IAM, all running locally via LocalStack for easy development and testing.

---

## Architecture

The workflow is simple and powerful:

`[User] -> uploads image -> [S3 Bucket: bucket-originais] -> triggers -> [Lambda: processador-de-imagens-ts] -> resizes with Sharp -> [S3 Bucket: bucket-redimensionadas]`

---

## Features

-   **Event-Driven:** The entire process is triggered automatically when a new image is uploaded.
-   **Serverless:** Powered by AWS Lambda, requiring no server management.
-   **Local Development:** Uses LocalStack to emulate AWS services locally, making development free and fast.
-   **TypeScript:** The Lambda function is written in TypeScript for robust, type-safe code.
-   **Automated Setup:** Includes a shell script to create and configure all necessary resources.

---

## Prerequisites

Before you begin, ensure you have the following tools installed on your system:

-   [Git](https://git-scm.com/)
-   [Node.js](https://nodejs.org/) (v18.x or later) & npm
-   [Docker](https://www.docker.com/products/docker-desktop/) and [Docker Compose](https://docs.docker.com/compose/install/)
-   [AWS CLI](https://aws.amazon.com/cli/)
-   [`awslocal`](https://github.com/localstack/awscli-local): The wrapper for using the AWS CLI with LocalStack.
    ```bash
    pip install awscli-local
    ```

---

## Getting Started

Follow these steps to set up and run the project locally.

### 1. Clone the Repository

Clone this project to your local machine.
```bash
git clone <YOUR_REPOSITORY_URL>
cd <repository-name>
````

### 2\. Configure LocalStack

This project assumes you have a `docker-compose.yml` file to start LocalStack. If you don't have one, you can use the example below.

\<details\>
\<summary\>Click to see a sample \<b\>docker-compose.yml\</b\>\</summary\>

```yaml
# docker-compose.yml
version: "3.8"

services:
  localstack:
    container_name: "localstack-main"
    image: localstack/localstack:latest
    ports:
      - "127.0.0.1:4566:4566"            # LocalStack Gateway
      - "127.0.0.1:4510-4559:4510-4559"  # External services
    environment:
      - DEBUG=${DEBUG:-0}
    volumes:
      - "${LOCALSTACK_VOLUME_DIR:-./volume}:/var/lib/localstack"
      - "/var/run/docker.sock:/var/run/docker.sock"
```

\</details\>

### 3\. Start LocalStack

Start your local cloud environment. If you're using `colima` on macOS, start it first.

```bash
# If using Colima on macOS
colima start

# Start the LocalStack container
docker-compose up -d
```

### 4\. Install Project Dependencies

Navigate into the Lambda function's directory and install the required `npm` packages.

```bash
cd lambda-image-processor
npm install
cd ..
```

### 5\. Run the Setup Script

Execute the setup script from the project root. This will create the S3 buckets, IAM Role, and Lambda function inside your LocalStack container.

```bash
./setup-localstack.sh
```

After the script finishes, your environment is ready\!

-----

## Usage: Testing the Pipeline

To test the entire flow, upload an image to the source bucket.

### 1\. Upload an Image

Use `awslocal` to copy an image from your computer to the `bucket-originais`.

```bash
# Replace the path with the actual path to your image
awslocal s3 cp ~/Downloads/my-photo.jpeg s3://bucket-originais/
```

### 2\. Verify the Result

The Lambda should have triggered, resized the image, and saved it to the destination bucket.

**Option A: List bucket contents via CLI**

```bash
awslocal s3 ls s3://bucket-redimensionadas/
```

You should see your file listed here.

**Option B: Download the resized image**

```bash
awslocal s3 cp s3://bucket-redimensionadas/my-photo.jpeg ./resized-photo.jpeg
```

This will download the file to your current directory.

**Option C: View in Browser**

You can access the resized image directly via the LocalStack S3 URL:

`http://bucket-redimensionadas.s3.localhost.localstack.cloud:4566/my-photo.jpeg`

-----

## Development & Debugging

Here are some useful commands for development.

### Check Lambda Logs

To see the logs generated by your Lambda function as it executes:

```bash
awslocal logs tail /aws/lambda/processador-de-imagens-ts --follow
```

### Check LocalStack Container Logs

For lower-level logs about all LocalStack services:

```bash
docker logs -f localstack-main
```

### Update Lambda Code

If you only change the Lambda's TypeScript code, you can use the `update-lambda.sh` script for a much faster deployment without recreating all resources.

```bash
./update-lambda.sh
```

### Tear Down the Environment

To delete all the resources created by the setup script:

```bash
./teardown.sh
```

To stop the LocalStack container:

```bash
docker-compose down
```